function getTileCoords(e,t){return[Math.floor(e/TILE_SIZE),Math.floor(t/TILE_SIZE)]}function convertTileCoords(e,t){return[e*TILE_SIZE,t*TILE_SIZE]}var SPRITE_SIZE=16,TILE_SIZE=32,CHAR_SIZE=32,SITE_URL=window.location.origin+"/WoA/assets/game/",USERS_DATA={id_username:{name:"id_username",xCoord:3,yCoord:4,direction:0,walking:!1,walkstate:0}},USER_DATA={name:"id_username"},AJAX={MAP_DATA:null,TILES:null},getMapData=new XMLHttpRequest;getMapData.onreadystatechange=function(){4==this.readyState&&200==this.status&&(AJAX.MAP_DATA=this)},getMapData.open("GET",SITE_URL+"js/debug/kaas.json",!0),getMapData.send();var getTiles=new XMLHttpRequest;getTiles.onreadystatechange=function(){4==this.readyState&&200==this.status&&(AJAX.TILES=this)},getTiles.open("GET","/WoA/debug.php?select",!0),getTiles.send();var Game=function(e,t){this.width=e,this.height=t,this.fps=30,this.interval=Math.floor(1e3/this.fps),this.start=function(e,t){var i=setInterval(function(){var a=!1;for(var r in e)(null==e[r]||"undefined"==typeof e[r])&&(a=!0);if(!a){for(var r in e)e[r]=JSON.parse(e[r].responseText);clearInterval(i),t()}},this.interval)}},Canvas=function(e,t,i,a){elem=a||document.getElementsByTagName("body")[0],this.canvas=null,this.createContext=function(){var t='<canvas id="'+e+'" width="'+this.width+'" height="'+this.height+'"></canvas>';return elem.innerHTML+=t,this.canvas=document.getElementById(e),this.canvas.getContext("2d")},this.width=t,this.height=i,this.context=this.createContext(),this.context.imageSmoothingEnabled=!1},Spritesheet=function(e){this.image=new Image,this.image.src=e,this.width=this.image.width,this.height=this.image.height},Map=function(e,t){this.map=t,this.spritesheet=tileset,this.drawMap=function(t){e.fillRect(0,0,640,384);for(var i=[],a=USERS_DATA[USER_DATA.name],r=new Spritesheet(SITE_URL+"images/user_sprites/"+a.name+".png"),s=convertTileCoords(9,5),o=a.xCoord-11,n=a.yCoord-7,h=a.xCoord-Math.floor(a.xCoord),l=a.yCoord-Math.floor(a.yCoord),d=0;14>d;d++)for(var E=0;22>E;E++)if(xPos=o+(E+1),yPos=n+(d+1),xPos>=0&&yPos>=0&&yPos<this.map.length&&xPos<this.map[Math.floor(yPos)].length)for(var f=this.map[Math.floor(yPos)][Math.floor(xPos)],I=convertTileCoords(E-h,d-l),S=0;S<f.tiles.length;S++){var A=AJAX.TILES[f.tiles[S]];1==A.over_player?i.push([A,I]):e.drawImage(tileset.image,A.clip_x,A.clip_y,SPRITE_SIZE,SPRITE_SIZE,I[0],I[1],TILE_SIZE,TILE_SIZE)}e.drawImage(r.image,CHAR_SIZE*a.walkstate,CHAR_SIZE*a.direction,CHAR_SIZE,CHAR_SIZE,s[0]+TILE_SIZE/2,s[1],2*CHAR_SIZE,2*CHAR_SIZE);for(var c in USERS_DATA){var _=USERS_DATA[c];if(_.name!=c){var v=new Spritesheet(SITE_URL+"images/user_sprites/"+_.name+".png"),I=convertTileCoords(_.xCoord-1,_.yCoord-1);e.drawImage(v.image,CHAR_SIZE*_.walkstate,CHAR_SIZE*_.direction,CHAR_SIZE,CHAR_SIZE,I[0]+TILE_SIZE/2,I[1],2*CHAR_SIZE,2*CHAR_SIZE)}for(var u=this.map[Math.floor(_.yCoord)][Math.floor(_.xCoord)].tiles,S=0;S<u.length;S++)if(0!=AJAX.TILES[u[S]].render_on_walk){var A=AJAX.TILES[AJAX.TILES[u[S]].render_on_walk];_.xCoord%1==0&&_.yCoord%1==0&&e.drawImage(tileset.image,A.clip_x,A.clip_y,SPRITE_SIZE,SPRITE_SIZE,s[0]+TILE_SIZE,s[1]+TILE_SIZE,TILE_SIZE,TILE_SIZE)}}for(var T=0;T<i.length;T++)e.drawImage(tileset.image,i[T][0].clip_x,i[T][0].clip_y,SPRITE_SIZE,SPRITE_SIZE,i[T][1][0],i[T][1][1],TILE_SIZE,TILE_SIZE);return t.animateUser(),DEBUG&&drawGrid("ui",TILE_SIZE),"done"},this.drawMapEditor=function(t){for(var i=0;i<t.length;i++)for(var a=0;a<t[i].length;a++){coords=convertTileCoords(a,i);for(var r=0;r<t[i][a].tiles.length;r++){var s=AJAX.TILES[t[i][a].tiles[r]];e.drawImage(tileset.image,s.clip_x,s.clip_y,SPRITE_SIZE,SPRITE_SIZE,coords[0],coords[1],TILE_SIZE,TILE_SIZE)}}SELECTED&&(begin=convertTileCoords(SELECTION[0],SELECTION[1]),end=convertTileCoords(SELECTION[2],SELECTION[3]),e.beginPath(),e.rect(begin[0],begin[1],end[0],end[1]),e.stroke(),e.closePath()),DEBUG&&drawGrid("new_map",TILE_SIZE)}},User=function(e){function t(e){var t=e.xCoord,i=e.yCoord,a=!0;switch(e.direction){case 0:i=Math.floor(e.yCoord)+1;break;case 1:t=Math.floor(e.xCoord)+1;break;case 2:i=Math.ceil(e.yCoord)-1;break;case 3:t=Math.ceil(e.xCoord)-1}if("undefined"!=typeof AJAX.MAP_DATA[i])if("undefined"!=typeof AJAX.MAP_DATA[i][t])for(var r=0;r<AJAX.MAP_DATA[i][t].tiles.length;r++)0==AJAX.TILES[AJAX.MAP_DATA[i][t].tiles[r]].walkable&&(a=!1);else a=!1;else a=!1;return a}this.user=USERS_DATA[e],this.keyHold=0,this.maxKeyHold=5,this.baseSpeed=.125,this.walkSpeed=.125,this.animationInterval,this.animationDelay=0,this.maxAnimationDelay=3,this.animateUser=function(){var e=!1;if(this.animationDelay++,this.animationDelay>this.maxAnimationDelay&&(this.animationDelay=0),this.animationDelay==this.maxAnimationDelay&&this.user.walkstate++,3==this.user.walkstate&&(this.user.walkstate=0),(window.key.up||window.key.down||window.key.left||window.key.right)&&(e=!0),this.keyHold++,(this.keyHold>this.maxKeyHold||!e)&&(this.keyHold=0),this.keyHold==this.maxKeyHold&&(this.animationInterval=!0),window.key.shift&&!this.animationInterval&&(this.walkSpeed=2*this.baseSpeed),window.key.shift||this.animationInterval||(this.walkSpeed=this.baseSpeed),this.animationInterval&&t(this.user)){var r,i=!0,a=this.walkSpeed;switch(0==this.user.direction&&(this.user.yCoord+=a),1==this.user.direction&&(this.user.xCoord+=a),2==this.user.direction&&(this.user.yCoord-=a),3==this.user.direction&&(this.user.xCoord-=a),this.user.xCoord%1!=0&&(i=!1),this.user.yCoord%1!=0&&(i=!1),this.user.direction){case 0:r=window.key.down;break;case 1:r=window.key.right;break;case 2:r=window.key.up;break;case 3:r=window.key.left}i&&!r&&(this.animationInterval=!1)}else this.user.walkstate=0,window.key.down&&(this.user.direction=0),window.key.right&&(this.user.direction=1),window.key.up&&(this.user.direction=2),window.key.left&&(this.user.direction=3)}};
